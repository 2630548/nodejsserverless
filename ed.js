(()=>{"use strict";var t=[,e=>{e.exports=require("tslib")},e=>{e.exports=require("http")},e=>{e.exports=require("ws")},e=>{e.exports=require("uuid")},e=>{e.exports=require("node:dns")},e=>{e.exports=require("node:dgram")},(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.vlessJs=r.processVlessHeader=r.closeWebSocket=r.makeReadableWebSocketStream=r.delay=void 0;var o=t(8);Object.defineProperty(r,"delay",{enumerable:!0,get:function(){return o.delay}}),Object.defineProperty(r,"makeReadableWebSocketStream",{enumerable:!0,get:function(){return o.makeReadableWebSocketStream}}),Object.defineProperty(r,"closeWebSocket",{enumerable:!0,get:function(){return o.safeCloseWebSocket}}),Object.defineProperty(r,"processVlessHeader",{enumerable:!0,get:function(){return o.processVlessHeader}}),Object.defineProperty(r,"vlessJs",{enumerable:!0,get:function(){return o.vlessJs}})},(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.processVlessHeader=r.safeCloseWebSocket=r.makeReadableWebSocketStream=r.delay=r.vlessJs=void 0;const i=t(1),f=t(4);r.vlessJs=function(){return"vless-js"};const o=1;function c(e){try{e.readyState===o&&e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}r.delay=function(t){return new Promise((e,r)=>{setTimeout(e,t)})},r.makeReadableWebSocketStream=function(o,s,a){let n=!1;return new ReadableStream({start(t){o.addEventListener("message",r=>i.__awaiter(this,void 0,void 0,function*(){var e;n||(e=r.data,t.enqueue(e))})),o.addEventListener("error",e=>{a("socket has error"),n=!0,t.error(e)}),o.addEventListener("close",()=>{try{a("webSocket is close"),n||t.close()}catch(e){a("websocketStream can't close DUE to ",e)}});var{earlyData:e,error:r}=function(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");var r=atob(e);return{earlyData:Uint8Array.from(r,e=>e.charCodeAt(0)).buffer,error:null}}catch(e){return{error:e}}}(s);r?(a("earlyDataHeader has invaild base64"),c(o)):e&&t.enqueue(e)},pull(e){},cancel(e){a("websocketStream is cancel DUE to ",e),n||(n=!0,c(o))}})},r.safeCloseWebSocket=c,r.processVlessHeader=function(e,r){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};var t=new Uint8Array(e.slice(0,1));let o=!1,s=!1;if(!(o=(0,f.stringify)(new Uint8Array(e.slice(1,17)))===r?!0:o))return{hasError:!0,message:"invalid user"};var r=new Uint8Array(e.slice(17,18))[0],a=new Uint8Array(e.slice(18+r,18+r+1))[0];if(1!==a){if(2!==a)return{hasError:!0,message:`command ${a} is not support, command 01-tcp,02-udp,03-mux`};s=!0}var a=18+r+1,r=e.slice(a,a+2),r=new DataView(r).getInt16(0),a=a+2,n=new Uint8Array(e.slice(a,a+1))[0];let i=0,c=a+1,l="";switch(n){case 1:i=4,l=new Uint8Array(e.slice(c,c+i)).join(".");break;case 2:i=new Uint8Array(e.slice(c,c+1))[0],c+=1,l=(new TextDecoder).decode(e.slice(c,c+i));break;case 3:i=16;var d=new DataView(e.slice(c,c+i)),u=[];for(let e=0;e<8;e++)u.push(d.getUint16(2*e).toString(16));l=u.join(":");break;default:console.log("invild  addressType is "+n)}return l?{hasError:!1,addressRemote:l,portRemote:r,rawDataIndex:c+i,vlessVersion:t,isUDP:s}:{hasError:!0,message:"addressValue is empty, addressType is "+n}}},e=>{e.exports=require("node:net")},e=>{e.exports=require("stream")},e=>{e.exports=require("node:stream/web")}],o={};function s(e){var r=o[e];return void 0!==r||(r=o[e]={exports:{}},t[e](r,r.exports,s)),r.exports}var e={};{var r=e;Object.defineProperty(r,"__esModule",{value:!0});const h=s(1),c=s(2),l=s(3),d=s(4),u=s(5),S=s(6),g=s(7),k=s(9),W=s(10),_=s(11);function y(e){try{e.close()}catch(e){console.log("error close udp",e)}}r.createVLESSServer=function(e,w){e=e||process.env.PORT||"3001";const n=process.env.SMALLRAM||!1;w=w||process.env.UUID||"d342d11e-d424-4583-b36e-524ab1f0afa4";var r=process.env.DNSORDER||"verbatim";"ipv4first"===r&&(0,u.setDefaultResultOrder)(r);const a=(0,d.validate)(w);function i(e,r,t){e.writeHead(r),e.write(t),e.end()}a||console.log("not set valid UUID"),r=(0,c.createServer)((e,r)=>{var t,o,s=new URL(e.url,"http://"+e.headers.host);a?"GET"===e.method?(o=r,(t=s).pathname.startsWith("/health")?i(o,200,"health 200"):t.pathname.startsWith("/")&&i(o,200,"hello world")):(t=e).headers["user-agent"].includes("Mozilla/5.0")&&"websocket"!==t.headers.upgrade?(o=w,s.pathname.includes(o)&&(r.writeHead(200),r.write(w),r.end())):(r.writeHead(401),r.write("user-agent not mozilla"),r.end()):(r.writeHead(401),r.write("not set valid UUID"),r.end())});const o=new l.WebSocketServer({noServer:!0});o.on("connection",function(s,a){return h.__awaiter(this,void 0,void 0,function*(){let p="",v="";const t=a.socket.remoteAddress;try{const m=(e,r)=>{console.log(`Address ${p}:${v} ${e} from address: `+t,r||"")};let d=null,u=null,f;var r=a.headers["sec-websocket-protocol"],o=(0,g.makeReadableWebSocketStream)(s,r,m);let b=null,e=(o.pipeTo(new _.WritableStream({write(c,l){return h.__awaiter(this,void 0,void 0,function*(){var e,r,t,o,s,a,n,i;Buffer.isBuffer(c)||(c=Buffer.from(c)),u?(yield(e=u.writable.getWriter()).write(c.buffer.slice(c.byteOffset,c.byteOffset+c.length)),e.releaseLock()):d?yield function(e,o){return h.__awaiter(this,void 0,void 0,function*(){return new Promise((r,t)=>{e.write(o,e=>{e?t(e):r("")})})})}(d,c):(e=c.buffer.slice(c.byteOffset,c.byteOffset+c.length),{hasError:i,message:r,portRemote:t,addressRemote:n,rawDataIndex:o,vlessVersion:s,isUDP:a}=(0,g.processVlessHeader)(e,w),p=n||"",v=t+` ${a?"udp":"tcp"} `,i?l.error(`Address ${p}:${v} ${r} `):(console.log(`Address ${p}:${v} connecting`),b=new Uint8Array([s[0],0]),n=e.slice(o),a?((i=(u=function(a,n){const i=(0,S.createSocket)("udp4"),e=new _.TransformStream({start(t){i.on("message",(e,r)=>{t.enqueue(Buffer.concat([new Uint8Array([r.size>>8&255,255&r.size]),e]))}),i.on("error",e=>{console.log("udpClient error event",e),t.error(e)})},transform(o,s){return h.__awaiter(this,void 0,void 0,function*(){for(let e=0;e<o.byteLength;){var r=o.slice(e,e+2),r=new DataView(r).getInt16(0);const t=new Uint8Array(o.slice(e+2,e+2+r));e=e+2+r,yield new Promise((r,e)=>{i.send(t,a,n,e=>{e&&(console.log("udps send error",e),s.error("Failed to send UDP packet !! "+e),y(i)),r(!0)})}),e=e}})},flush(e){y(i),e.terminate()}});return e}(t,p)).writable.getWriter()).write(n).catch(e=>console.log),i.releaseLock(),f(u)):((d=yield function(o,s,a){return h.__awaiter(this,void 0,void 0,function*(){return new Promise((e,r)=>{const t=(0,k.connect)({port:o,host:s},()=>{a("connected"),e(t)});t.addListener("error",()=>{r("remoteSocket has error")})})})}(t,p,m)).write(new Uint8Array(n)),f(d))))})},close(){console.log(`Address ${p}:${v} readableWebSocketStream is close`)},abort(e){console.log(`Address ${p}:${v} readableWebSocketStream is abort`,JSON.stringify(e))}})).catch(e=>{console.error(`Address ${p}:${v} readableWebSocketStream pipeto has exception`,e.stack||e)}),yield new Promise(e=>f=e),null===u||void 0===u?void 0:u.readable);d&&(e=W.Readable.toWeb(d,{strategy:{highWaterMark:n?100:1e3}}));yield e.pipeTo(new _.WritableStream({start(){s.readyState===s.OPEN&&s.send(b)},write(e,r){return h.__awaiter(this,void 0,void 0,function*(){s.readyState===s.OPEN?yield function(e,o){return h.__awaiter(this,void 0,void 0,function*(){return new Promise((r,t)=>{e.send(o,e=>{e?t(e):r("")})})})}(s,e):d.destroyed||d.destroy()})},close(){console.log(`Address ${p}:${v} remoteConnection!.readable is close`)},abort(e){(0,g.closeWebSocket)(s),console.error(`Address ${p}:${v} remoteConnection!.readable abort`,e)}}))}catch(e){console.error(`Address ${p}:${v} processWebSocket has exception `,e.stack||e),(0,g.closeWebSocket)(s)}})}),r.on("upgrade",(r,e,t)=>o.handleUpgrade(r,e,t,e=>o.emit("connection",e,r))),r.listen({port:e,host:"::"},()=>console.log(`Server is listening on port: ${e}
`))}}var a,n=exports;for(a in e)n[a]=e[a];e.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();